
{% extends "admin/base.html" %}

{% block title %}Adicionar Produto - Admin Kariri Xoc√≥{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="text-indigenous-brown">
                <i class="fas fa-plus me-2"></i>
                Adicionar Produto
            </h1>
            <a href="{{ url_for('products') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>
                Voltar
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Informa√ß√µes do Produto</h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="name" class="form-label">Nome do Produto <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="name" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="category_id" class="form-label">Categoria <span class="text-danger">*</span></label>
                                <select class="form-select" id="category_id" name="category_id" required>
                                    <option value="">Selecione uma categoria</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Descri√ß√£o</label>
                        <textarea class="form-control" id="description" name="description" rows="4" 
                                  placeholder="Descreva o produto, materiais utilizados, t√©cnicas artesanais..."></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="price" class="form-label">Pre√ßo (R$) <span class="text-danger">*</span></label>
                                <input type="number" step="0.01" min="0" class="form-control" id="price" name="price" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="stock_quantity" class="form-label">Quantidade em Estoque</label>
                                <input type="number" min="0" class="form-control" id="stock_quantity" name="stock_quantity" value="0">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="images" class="form-label">Imagens do Produto</label>
                        <input type="file" class="form-control" id="images" name="images" multiple accept="image/*">
                        <div class="form-text">
                            Selecione uma ou mais imagens. A primeira imagem ser√° a principal.
                            Formatos aceitos: PNG, JPG, JPEG, GIF, WEBP (m√°x. 16MB cada)
                        </div>
                    </div>

                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" id="is_active" name="is_active" checked>
                        <label class="form-check-label" for="is_active">
                            Produto ativo (vis√≠vel na loja)
                        </label>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('products') }}" class="btn btn-outline-secondary me-md-2">Cancelar</a>
                        <button type="submit" class="btn btn-indigenous-orange">
                            <i class="fas fa-save me-2"></i>
                            Salvar Produto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Dicas para Produtos</h5>
            </div>
            <div class="card-body">
                <h6 class="text-indigenous-orange">üì∏ Imagens</h6>
                <ul class="list-unstyled small">
                    <li>‚Ä¢ Use fotos em boa qualidade</li>
                    <li>‚Ä¢ Primeira imagem = principal</li>
                    <li>‚Ä¢ M√∫ltiplas imagens mostram detalhes</li>
                </ul>

                <h6 class="text-indigenous-orange">üí∞ Pre√ßos</h6>
                <ul class="list-unstyled small">
                    <li>‚Ä¢ Use valores reais (R$)</li>
                    <li>‚Ä¢ Ex: 25.50 para R$ 25,50</li>
                </ul>

                <h6 class="text-indigenous-orange">üìù Descri√ß√£o</h6>
                <ul class="list-unstyled small">
                    <li>‚Ä¢ Conte a hist√≥ria do produto</li>
                    <li>‚Ä¢ Materiais utilizados</li>
                    <li>‚Ä¢ Significado cultural</li>
                </ul>

                <h6 class="text-indigenous-orange">üì¶ Estoque</h6>
                <ul class="list-unstyled small">
                    <li>‚Ä¢ Deixe 0 se feito sob encomenda</li>
                    <li>‚Ä¢ Produtos √∫nicos = quantidade 1</li>
                </ul>
            </div>
        </div>
    </div>
</div>

{% if not categories %}
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Aten√ß√£o:</strong> Voc√™ precisa criar pelo menos uma categoria antes de adicionar produtos.
            <a href="{{ url_for('categories') }}" class="alert-link">Gerenciar Categorias</a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Preview de imagens selecionadas
document.getElementById('images').addEventListener('change', function(e) {
    const files = e.target.files;
    const existingPreview = document.getElementById('imagePreview');
    
    if (existingPreview) {
        existingPreview.remove();
    }
    
    if (files.length > 0) {
        const previewContainer = document.createElement('div');
        previewContainer.id = 'imagePreview';
        previewContainer.className = 'mt-3';
        
        const title = document.createElement('h6');
        title.textContent = 'Pr√©-visualiza√ß√£o das imagens:';
        previewContainer.appendChild(title);
        
        const row = document.createElement('div');
        row.className = 'row';
        
        for (let i = 0; i < Math.min(files.length, 4); i++) {
            const file = files[i];
            const col = document.createElement('div');
            col.className = 'col-3 position-relative';
            
            const img = document.createElement('img');
            img.className = 'img-thumbnail';
            img.style.height = '100px';
            img.style.objectFit = 'cover';
            img.style.width = '100%';
            
            if (i === 0) {
                const badge = document.createElement('span');
                badge.className = 'badge bg-primary position-absolute top-0 start-0';
                badge.textContent = 'Principal';
                badge.style.fontSize = '0.7rem';
                col.appendChild(badge);
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            
            col.appendChild(img);
            row.appendChild(col);
        }
        
        if (files.length > 4) {
            const moreCol = document.createElement('div');
            moreCol.className = 'col-12 text-center mt-2';
            moreCol.innerHTML = `<small class="text-muted">+${files.length - 4} mais imagens selecionadas</small>`;
            row.appendChild(moreCol);
        }
        
        previewContainer.appendChild(row);
        this.parentNode.appendChild(previewContainer);
    }
});

// Formata√ß√£o de pre√ßo
document.getElementById('price').addEventListener('input', function(e) {
    let value = e.target.value;
    if (value) {
        // Remove caracteres n√£o num√©ricos exceto ponto
        value = value.replace(/[^\d.]/g, '');
        // Garante apenas um ponto decimal
        const parts = value.split('.');
        if (parts.length > 2) {
            value = parts[0] + '.' + parts.slice(1).join('');
        }
        e.target.value = value;
    }
});
</script>
{% endblock %}
